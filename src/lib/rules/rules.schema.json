{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agentic-canvas.dev/schemas/rules.schema.json",
  "title": "Agentic Canvas Rules",
  "type": "object",
  "required": ["version"],
  "additionalProperties": false,
  "properties": {
    "version": { "const": "v1" },
    "global": { "$ref": "#/$defs/RuleBlock" },
    "integrations": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "slack": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "mentions": { "$ref": "#/$defs/RuleBlock" },
            "channel_activity": { "$ref": "#/$defs/RuleBlock" }
          }
        },
        "github": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "prs": { "$ref": "#/$defs/RuleBlock" },
            "issues": { "$ref": "#/$defs/RuleBlock" }
          }
        },
        "vercel": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "deployments": { "$ref": "#/$defs/RuleBlock" }
          }
        }
      }
    }
  },
  "$defs": {
    "RuleBlock": {
      "type": "object",
      "required": ["rules"],
      "additionalProperties": false,
      "properties": {
        "rules": {
          "type": "array",
          "items": { "$ref": "#/$defs/Rule" }
        }
      }
    },
    "RuleBase": {
      "type": "object",
      "required": ["type", "phase", "target"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string" },
        "type": { "$ref": "#/$defs/RuleType" },
        "phase": { "$ref": "#/$defs/RulePhase" },
        "target": { "$ref": "#/$defs/RuleTarget" },
        "priority": { "type": "integer" },
        "enabled": { "type": "boolean", "default": true },
        "params": { "type": "object" }
      }
    },
    "RuleType": {
      "enum": [
        "filter.limit",
        "filter.channel.include",
        "filter.keyword.include",
        "filter.keyword.exclude",
        "sort.recent",
        "sort.score_then_recent",
        "score.llm_classifier"
      ]
    },
    "RulePhase": {
      "enum": ["filter", "score", "sort", "limit", "trigger", "route", "compose", "suppress"]
    },
    "RuleTarget": {
      "enum": [
        "slack.mentions",
        "slack.channel_activity",
        "github.prs",
        "github.issues",
        "vercel.deployments",
        "assistant.suggestions",
        "space.template",
        "space.layout",
        "notifications"
      ]
    },
    "Rule": {
      "oneOf": [
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "filter.limit" },
                "phase": { "const": "limit" },
                "params": {
                  "type": "object",
                  "required": ["count"],
                  "additionalProperties": false,
                  "properties": {
                    "count": { "type": "integer", "minimum": 1 }
                  }
                }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "sort.recent" },
                "phase": { "const": "sort" }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "sort.score_then_recent" },
                "phase": { "const": "sort" }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "filter.channel.include" },
                "phase": { "const": "filter" },
                "params": {
                  "type": "object",
                  "required": ["channels"],
                  "additionalProperties": false,
                  "properties": {
                    "channels": {
                      "type": "array",
                      "items": { "type": "string" },
                      "minItems": 1
                    }
                  }
                }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "filter.keyword.include" },
                "phase": { "const": "filter" },
                "params": {
                  "type": "object",
                  "required": ["keywords"],
                  "additionalProperties": false,
                  "properties": {
                    "keywords": {
                      "type": "array",
                      "items": { "type": "string" },
                      "minItems": 1
                    }
                  }
                }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "filter.keyword.exclude" },
                "phase": { "const": "filter" },
                "params": {
                  "type": "object",
                  "required": ["keywords"],
                  "additionalProperties": false,
                  "properties": {
                    "keywords": {
                      "type": "array",
                      "items": { "type": "string" },
                      "minItems": 1
                    }
                  }
                }
              }
            }
          ]
        },
        {
          "allOf": [
            { "$ref": "#/$defs/RuleBase" },
            {
              "properties": {
                "type": { "const": "score.llm_classifier" },
                "phase": { "const": "score" },
                "params": {
                  "type": "object",
                  "required": ["instruction"],
                  "additionalProperties": false,
                  "properties": {
                    "instruction": { "type": "string", "minLength": 1 },
                    "weight": { "type": "number", "minimum": 0, "default": 1 },
                    "maxItems": { "type": "integer", "minimum": 1, "maximum": 200 }
                  }
                }
              }
            }
          ]
        }
      ]
    }
  }
}
